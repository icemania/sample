<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>アイスマニア検定</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts (任意) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap"
    rel="stylesheet"
  />

  <!-- Tailwind CSS CDN -->
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@3.2.7/dist/tailwind.min.css"
    rel="stylesheet"
  />

  <!-- React / ReactDOM CDN -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <!-- Babel (JSX変換用) -->
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <!-- canvas-confetti (紙吹雪) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <style>
    body {
      font-family: 'Open Sans', sans-serif;
    }
    /* フェードインアニメーション */
    @keyframes fadeIn {
      0%   { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-700 via-purple-600 to-pink-500 min-h-screen flex items-center justify-center p-6">
  <div id="root" class="w-full"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // 47都道府県リスト
    const prefectures = [
      "—選択して下さい—", "北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県",
      "茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県",
      "新潟県", "富山県", "石川県", "福井県", "山梨県", "長野県", "岐阜県", "静岡県",
      "愛知県", "三重県", "滋賀県", "京都府", "大阪府", "兵庫県", "奈良県", "和歌山県",
      "鳥取県", "島根県", "岡山県", "広島県", "山口県", "徳島県", "香川県", "愛媛県",
      "高知県", "福岡県", "佐賀県", "長崎県", "熊本県", "大分県", "宮崎県", "鹿児島県",
      "沖縄県"
    ];

    // クイズ問題データ（サンプル）
    const questionsData = [
      {
        question: "【Q1】アイスクリームの主な原料は？",
        choices: ["牛乳・乳製品", "コーヒー豆", "緑茶葉", "小麦粉"],
        correctIndex: 0,
        explanation: "牛乳をベースに乳製品や砂糖、卵などを組み合わせて作られます。"
      },
      {
        question: "【Q2】日本で初めてアイスクリームが製造・販売されたのはいつ頃？",
        choices: ["江戸時代", "明治時代", "大正時代", "昭和初期"],
        correctIndex: 1,
        explanation: "1869年（明治2年）に横浜で製造販売されたとされています。"
      },
      {
        question: "【Q3】アイスクリームと氷菓の大きな違いは何？",
        choices: [
          "甘さの種類",
          "原材料の乳固形分や乳脂肪分の量",
          "製造方法が全く異なる",
          "賞味期限が大きく違う"
        ],
        correctIndex: 1,
        explanation: "アイスクリームは乳固形分や乳脂肪分が一定以上含まれるが、氷菓は氷菓子で乳脂肪分は含まれません。"
      },
      {
        question: "【Q4】日本アイスマニア協会が監修している資格はどれ？",
        choices: ["アイスマニア検定", "アイス鑑定士", "フローズンソムリエ", "アイスプロフェッサー"],
        correctIndex: 0,
        explanation: "「アイスマニア検定」は日本アイスマニア協会が監修している検定です。"
      },
    ];

    // 紙吹雪演出
    function triggerConfetti() {
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 }
      });
    }

    // メインコンポーネント
    function App() {
      const [currentQuestion, setCurrentQuestion] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState(null);
      const [score, setScore] = useState(0);
      const [showResult, setShowResult] = useState(false);
      const [passed, setPassed] = useState(false);

      const handleAnswerChange = (index) => {
        setSelectedAnswer(index);
      };

      const handleNext = () => {
        if (selectedAnswer === null) return;
        // 正解ならスコア加算
        if (selectedAnswer === questionsData[currentQuestion].correctIndex) {
          setScore(score + 1);
        }
        // 次へ or 結果表示
        if (currentQuestion < questionsData.length - 1) {
          setCurrentQuestion(currentQuestion + 1);
          setSelectedAnswer(null);
        } else {
          // 最終問題回答後
          const finalScore = (selectedAnswer === questionsData[currentQuestion].correctIndex)
            ? score + 1
            : score;
          const percentage = (finalScore / questionsData.length) * 100;
          setPassed(percentage >= 80); // 80点以上で合格
          setShowResult(true);

          // ランキング保存（ローカルストレージ）
          const storedScores = JSON.parse(localStorage.getItem("iceManiaScores")) || [];
          storedScores.push(percentage);
          localStorage.setItem("iceManiaScores", JSON.stringify(storedScores));
        }
      };

      if (showResult) {
        // 結果画面へ
        const finalPercentage = Math.round((score / questionsData.length) * 100);
        return (
          <Result
            passed={passed}
            score={finalPercentage}
            questions={questionsData}
          />
        );
      }

      const question = questionsData[currentQuestion];

      return (
        <div className="fade-in mx-auto w-full max-w-3xl">
          <div className="bg-white/80 backdrop-blur-md shadow-2xl ring-1 ring-white/20 rounded-lg p-6 sm:p-10 transition transform hover:-translate-y-1 hover:shadow-[0_10px_30px_rgba(0,0,0,0.3)]">
            <h1 className="text-3xl font-bold text-center mb-6 text-gray-900">
              アイスマニア検定
            </h1>
            <p className="text-center text-gray-700 mb-2">
              問題 {currentQuestion + 1} / {questionsData.length}
            </p>
            <h2 className="text-xl font-semibold mb-4 text-center text-gray-800">
              {question.question}
            </h2>

            {/* 4択を縦に配置 */}
            <div className="flex flex-col space-y-3 mb-6">
              {question.choices.map((choice, index) => (
                <label
                  key={index}
                  className="flex items-center p-3 rounded-lg cursor-pointer bg-white/60 hover:bg-pink-50 transition-colors"
                >
                  <input
                    type="radio"
                    name={`question-${currentQuestion}`}
                    checked={selectedAnswer === index}
                    onChange={() => handleAnswerChange(index)}
                    className="form-radio h-5 w-5 text-pink-600 focus:ring-pink-500"
                  />
                  <span className="ml-3 text-gray-800">{choice}</span>
                </label>
              ))}
            </div>

            <button
              className={
                "w-full py-3 rounded text-white font-semibold transition transform " +
                (selectedAnswer === null
                  ? "bg-gray-400 cursor-not-allowed"
                  : "bg-pink-600 hover:bg-pink-700 hover:scale-105")
              }
              onClick={handleNext}
              disabled={selectedAnswer === null}
            >
              {currentQuestion === questionsData.length - 1 ? "結果を確認" : "次へ"}
            </button>
          </div>
        </div>
      );
    }

    // 結果画面
    function Result({ passed, score, questions }) {
      const [showExplanation, setShowExplanation] = useState(false);

      useEffect(() => {
        if (passed) {
          triggerConfetti();
        }
      }, [passed]);

      const toggleExplanation = () => setShowExplanation(!showExplanation);
      const handleRetry = () => window.location.reload();

      // スコア管理
      const storedScores = JSON.parse(localStorage.getItem("iceManiaScores")) || [];
      const allSortedScores = [...storedScores].sort((a, b) => b - a);
      const topScores = allSortedScores.slice(0, 5);
      const myRank = allSortedScores.indexOf(score) + 1;
      const totalCount = allSortedScores.length;

      if (passed) {
        return (
          <div className="fade-in mx-auto w-full max-w-3xl">
            <div className="bg-white/80 backdrop-blur-md shadow-2xl ring-1 ring-white/20 rounded-lg p-6 sm:p-10 text-center transition transform hover:-translate-y-1 hover:shadow-[0_10px_30px_rgba(0,0,0,0.3)]">
              <h2 className="text-3xl font-bold mb-4 text-gray-900">
                合格！ {score}点
              </h2>
              <p className="mb-4 text-gray-700">
                おめでとうございます！見事、アイスマニア検定に合格しました！
              </p>

              {/* 会員登録フォーム */}
              <h3 className="text-xl font-semibold mt-8 mb-3 text-gray-800">
                協会員登録フォーム
              </h3>
              <form className="mx-auto max-w-sm text-left">
                <label className="block mt-4">
                  <span className="text-gray-800">お名前</span>
                  <span className="text-red-500 ml-1">※（必須）</span>
                  <input
                    type="text"
                    name="name"
                    required
                    placeholder="例）鈴木　一郎"
                    className="border border-gray-300 rounded w-full p-2 mt-1"
                  />
                </label>
                <label className="block mt-4">
                  <span className="text-gray-800">フリガナ</span>
                  <span className="text-red-500 ml-1">※（必須）</span>
                  <input
                    type="text"
                    name="furigana"
                    required
                    placeholder="例）スズキ　イチロウ"
                    className="border border-gray-300 rounded w-full p-2 mt-1"
                  />
                </label>
                <label className="block mt-4">
                  <span className="text-gray-800">性別</span>
                  <span className="text-red-500 ml-1">※（必須）</span>
                  <select
                    name="gender"
                    required
                    className="border border-gray-300 rounded w-full p-2 mt-1"
                  >
                    <option value="">—選択して下さい—</option>
                    <option>男性</option>
                    <option>女性</option>
                    <option>その他</option>
                  </select>
                </label>
                <label className="block mt-4">
                  <span className="text-gray-800">年代</span>
                  <span className="text-red-500 ml-1">※（必須）</span>
                  <select
                    name="age"
                    required
                    className="border border-gray-300 rounded w-full p-2 mt-1"
                  >
                    <option value="">—選択して下さい—</option>
                    <option>10代</option>
                    <option>20代</option>
                    <option>30代</option>
                    <option>40代</option>
                    <option>50代</option>
                    <option>60代</option>
                    <option>70代</option>
                    <option>80代</option>
                  </select>
                </label>
                <label className="block mt-4">
                  <span className="text-gray-800">お住まい</span>
                  <span className="text-red-500 ml-1">※（必須）</span>
                  <select
                    name="prefecture"
                    required
                    className="border border-gray-300 rounded w-full p-2 mt-1"
                  >
                    {prefectures.map((pref, i) => (
                      <option key={i} value={pref}>{pref}</option>
                    ))}
                  </select>
                </label>
                <label className="block mt-4">
                  <span className="text-gray-800">メールアドレス</span>
                  <span className="text-red-500 ml-1">※（必須）</span>
                  <input
                    type="email"
                    name="email"
                    required
                    className="border border-gray-300 rounded w-full p-2 mt-1"
                  />
                </label>
                <label className="block mt-4">
                  <span className="text-gray-800">メールアドレス(確認用)</span>
                  <span className="text-red-500 ml-1">※（必須）</span>
                  <input
                    type="email"
                    name="emailConfirm"
                    required
                    className="border border-gray-300 rounded w-full p-2 mt-1"
                  />
                </label>

                <button
                  type="submit"
                  className="mt-6 bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded w-full transition transform hover:scale-105"
                >
                  会員登録する
                </button>
              </form>

              {/* ランキング */}
              <RankingList
                scores={topScores}
                allScores={allSortedScores}
                currentScore={score}
                myRank={myRank}
                totalCount={totalCount}
              />
            </div>
          </div>
        );
      } else {
        // 不合格画面
        return (
          <div className="fade-in mx-auto w-full max-w-3xl">
            <div className="bg-white/80 backdrop-blur-md shadow-2xl ring-1 ring-white/20 rounded-lg p-6 sm:p-10 text-center transition transform hover:-translate-y-1 hover:shadow-[0_10px_30px_rgba(0,0,0,0.3)]">
              <h2 className="text-3xl font-bold mb-4 text-gray-900">
                不合格… {score}点
              </h2>
              <p className="mb-4 text-gray-700">
                残念！80点以上で合格となります。
              </p>

              <div className="flex flex-col sm:flex-row gap-4 justify-center mb-4">
                <button
                  className="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded transition transform hover:scale-105"
                  onClick={toggleExplanation}
                >
                  回答解説を見る
                </button>
                <button
                  className="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded transition transform hover:scale-105"
                  onClick={handleRetry}
                >
                  再チャレンジ
                </button>
              </div>

              {showExplanation && (
                <div className="mt-4 text-left">
                  {questions.map((q, idx) => (
                    <AccordionItem key={idx} question={q} index={idx} />
                  ))}
                </div>
              )}

              {/* ランキング */}
              <RankingList
                scores={topScores}
                allScores={allSortedScores}
                currentScore={score}
                myRank={myRank}
                totalCount={totalCount}
              />
            </div>
          </div>
        );
      }
    }

    // アコーディオン項目（回答解説）
    function AccordionItem({ question, index }) {
      const [open, setOpen] = useState(false);
      const toggle = () => setOpen(!open);

      return (
        <div className="border-b border-gray-200 py-2">
          <div
            className="font-semibold cursor-pointer flex items-center hover:text-pink-600"
            onClick={toggle}
          >
            <span className="mr-2">問題 {index + 1}:</span>
            {question.question}
          </div>
          {open && (
            <div className="mt-2 ml-4 text-sm text-gray-700">
              <p className="mb-1">
                <span className="text-green-600 font-semibold">【正解】</span>
                {question.choices[question.correctIndex]}
              </p>
              <p>{question.explanation}</p>
            </div>
          )}
        </div>
      );
    }

    // ランキング表示コンポーネント
    function RankingList({ scores, allScores, currentScore, myRank, totalCount }) {
      return (
        <div className="mt-6 text-left">
          <h3 className="text-lg font-bold mb-2 text-gray-800">
            ランキング（過去スコア上位5件）
          </h3>
          <p className="mb-3 text-sm text-gray-700">
            あなたの順位：第 {myRank} 位 / {totalCount} 名中
          </p>
          <ul className="list-none pl-0">
            {scores.map((s, i) => (
              <li key={i} className="mb-1 text-gray-800">
                {i + 1}位：{Math.round(s)}点
              </li>
            ))}
          </ul>
        </div>
      );
    }

    // レンダリング
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
